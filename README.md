# YandexART Bots

В этом репозитории - примеры реализации двух телеграм-ботов на базе YandexART.

## YandexART Post-Cards

Этот бот умеет рисовать красивые новогодние открытки по короткому описанию:

![](img/train.jpg) | ![](img/kitten.jpg)
-------------------|---------------------
*Поезд* | *Наивный котик с большими глазами*

Бот работает за счет добавления базового промпта для рисования открытки с указанием объекта, который надо разместить в середине открытки. За счет качественного базового промпта удалось получить консистентный стиль.

Поскольку API YandexART асинхронное, то бот работает следующим образом:
* При поступлении запроса он формирует итоговый промпт и посылает запрос YandexART на рисование. Полученный `id` задачи запоминается в очереди redis, вместе с промптом и `chat_id` пользователя, сделавшего запрос.
* Периодически все задачи в очереди просматриваются и проверяется готовность картины. Если YandexART говорит, что картина готова - она отправляется пользователю.

## YandexART Flower Bot

Это более сложный бот, который умеет формировать букеты цветов для разных поводов. В этом боте промпт для YandexART формируется с помощью большой языковой модели YandexGPT.

![](img/for_girl.jpg) | ![](img/7nov.jpg)
----------------------|------------------
*Букет для девушки на свидание* | *Букет на 7 ноября*

Для экономии средств YandexGPT также используется в асинхронном режиме, на основе библиотеки [yandex-chain](https://github.com/yandex-datasphere/yandex-chain):  

* При поступлении запроса формируется промпт и посылается асинхронный запрос YandexGPT, `id` задачи (вместе с промптом и `chat_id` пользователя, сделавшего запрос) запоминается в очереди redis и помечается как GPT-запрос.
* Периодически очередь просматривается, и в зависимости от типа запроса:
  - Если это GPT-запрос, то проверяется готовность ответа YandexGPT. Если ответ готов - полученный промпт для YandexART посылается в запрос на рисование, полученный `id` задачи запоминается в очереди с пометкой "ART-запрос".
  - Если это ART-запрос, то проверяется готовность картины. Если картина готова - она отправляется пользователю.

## Технические детали

Боты реализованы в виде Flask-приложения на голом Telegram Bot API, с помощью веб-хуков. Для работы ботов необходимо развернуть их на виртуальной машине, например в Yandex Cloud.

Класс `TelegramBot`, описанный в `telegram.py`, отвечает за базовые функции по взаимодействию с Telegram API. Классы для реализации конкретных ботов (`FlowerBot` и `PCardBot`) унаследованы от него, и дополняют его конкретной функциональностью. Основной файл приложения `main.py` определяет веб-хуки для обработки телеграм-запросов, а также задаёт scheduler, необходимый для периодического опроса очереди.

## Установка

Предполагается, что у нас в распоряжении имеется виртуальная машина Yandex Cloud с назначенным на неё DNS-именем, а также что мы создали два телеграм-бота с помощью диалога с **@botfather** и получили соответствующие токены.

1. Клонируем этот репозиторий
2. На основе файла `config-sample.json` делаем файл `config.json`, куда записываем `folder_id` и `api_key` для работы с моделями YandexART и YandexGPT. Чтобы получить эти ключи, необходимо создать в облаке Yandex Cloud сервисный аккаунт и к нему API Key.
3. Устанавливаем Redis: `sudo apt install redis`
4. Устанавливаем [miniconda](https://eazify.net/miniconda). Можно использовать и другие Python-дистрибутивы.
5. Устанавливаем необходимые зависимости для Python: `pip install -r requirements.txt`
6. Получаем https-сертификаты для соответствующего доменного имени. Это проще всего сделать с помощью `[certbot](https://certbot.eff.org/)`.
7. Регистрируем телеграм-хуки с помощью скрипта `scripts/register-bots.sh`
8. Пробуем запустить веб-приложение с помощью `python main.py`. Возможно, в файле потребуется подправить пути к файлам с сертификатами. На этом этапе боты должны начать работать.
9. Для более устойчивой работы стоит запускать приложение из UWSGI-сервера. Для этого:
  - Устанавливаем UWSGI с поддержкой SSL: `conda install uwsgi`
  - Запускаем бота с помощью скрипта `scripts/start.sh` (скорее всего понадобится подправить пути к файлам с сертификатами).

## Credits

Данные боты разработаны [Дмитрием Сошниковым](https://soshnikov.com/ru), автором телеграм-канала [Облачный адвокат](http://t.me/shwarsico).